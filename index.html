<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>小白妹妹写代码</title>
  <meta name="author" content="Sabrina">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="小白妹妹写代码"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/tech/favicon.png" rel="icon">
  <link rel="alternate" href="/tech/atom.xml" title="小白妹妹写代码" type="application/atom+xml">
  <link rel="stylesheet" href="/tech/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/tech/">小白妹妹写代码</a></h1>
  <h2><a href="/tech/">一个废话很多的程序媛 | 我这么可爱一定是男孩子</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-12-01T10:46:26.000Z"><a href="/tech/2015/12/01/promise/">2015-12-01</a></time>
      
      
  
    <h1 class="title"><a href="/tech/2015/12/01/promise/">我所理解的Promise</a></h1>
  

    </header>
    <div class="entry">
      
        <p>（嫌我话多的可以直接看分割线之后的部分…）<br>以前高中的时候自己捣腾博客，一直也就只会用JQuery写点按钮事件什么的，连表单提交都没写过，后来误打误撞做了前端码农旧觉得JS的异步模式实在是太坑爹，当你搞清楚异步回调的时候，又会发现<a href="http://callbackhell.com/" target="_blank" rel="external">回调地狱(Callback Hell)</a>太坑爹…<br>为什么觉得异步坑爹？看看下面这个例子：</p>
<pre><code class="javascript"><span class="comment">//以下用setTimeout()模拟一个请求</span>
<span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>{
  <span class="keyword">return</span> <span class="string">"小白妹妹"</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">greeting</span>(<span class="params">name</span>) </span>{
  <span class="built_in">console</span>.log(<span class="string">"你好，"</span> + name);
}

<span class="comment">//生成一个0到1000的随机数，模拟不确定的等待时间0-1秒</span>
<span class="keyword">var</span> randomTime = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
  <span class="keyword">return</span> <span class="built_in">Math</span>.random() * <span class="number">1000</span>;
};

<span class="keyword">var</span> name = <span class="string">""</span>;
<span class="comment">//1秒之内给name赋值为 小白妹妹，但不知道具体时间</span>
setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
  name = getName();
}, randomTime());

greeting(name); <span class="comment">//以为得到name之后就可以开心的去打招呼啦，然而…</span>
</code></pre>
<h3 id="这是错的！这是错的！这是错的！">这是错的！这是错的！这是错的！</h3><p>可能很多新手都犯过这个错误，错的时候还不知道为啥错了…深究原因的话跟JS的机制有关，长篇大论的就不在这里多说了（其实是我说不清楚…）</p>
<p>再有点经验，就会知道，应该把 <code>greeting(name)</code> 写在回调函数里，这样就能保证在得到数据之后才运行 <code>greeting()</code> 函数，于是…当你有多个请求并且之间是有这种依赖关系的时候，可怕的回调地狱就出现了！<br>而解决回调地狱其中一个很优雅的方法，就是使用传说中的promise！</p>
<p>关于promise这个概念我前前后后看了有一年了，周围也没有认识的人可以给我讲，只能自己看看网上的文章，然而…<del>并没有什么卵用</del>…网上的文章都是众说纷纭，有一上来就defer的<a href="https://github.com/alsotang/node-lessons/tree/master/lesson17" target="_blank" rel="external">^1</a>，也有一上来就说如果你还在用defer你就理解错了Promise的<a href="http://web.jobbole.com/82601/" target="_blank" rel="external">^2</a>，就所以我到现在也不知道究竟什么样的理解才是对的…</p>
<p>关于<a href="http://segmentfault.com/a/1190000002452115" target="_blank" rel="external">Promise以及A+规范</a>就不在此详述了，那些概念的东东，我也还没完全理解。我想做的是让跟我一样的小白都能明白Promise最基本的用法。</p>
<hr>
<p>举个栗子…<br>有一个第三方提供的API，访问API能够得到一些用户数据（每访问一次得到一页，假设由于某些限制一页只返回3个用户）以及下一页的index；除了第一页之外，其他的页面都需要下一页的index参数才能访问到。（先不管这个API设计的合不合理…Facebook就有这样的API）<br><a href="http://example.com/user" target="_blank" rel="external">http://example.com/user</a>  <em>–&gt;访问第一页的用户数据</em><br><a href="http://example.com/user?next=xzmca" target="_blank" rel="external">http://example.com/user?next=xzmca</a>  <em>–&gt;访问第二页的用户数据</em><br>请求第一页时返回结果如下：</p>
<pre><code class="json">{
&quot;items&quot; : [{
  &quot;name&quot; : &quot;小白妹妹&quot;,
   &quot;age&quot; : 10
  }, 
  {...},
  {...}],
&quot;nextPage&quot; : &quot;xzmca&quot;,
&quot;lastPage&quot; : null
}
</code></pre>
<p>你可能会有这样的需求：你的APP一次需要显示6个甚至更多个的用户数据。而根据之前的API，一次只能拿到3个数据，那么就只能发出两次请求，并且<strong>第二次请求依赖于第一次请求的结果</strong>，由于异步的原因我们并不知道第一个请求什么时候才完成，<del>而我最初入坑时是让程序发完第一个请求后强制等2秒再发第二个请求我会告诉你们吗…</del></p>
<p>下面为了方便，使用<code>setTimeout()</code>函数和<a href="http://bluebirdjs.com/" target="_blank" rel="external">bluebird</a>库进行说明:</p>
<pre><code><span class="comment">//生成一个0到3000的随机数，模拟不确定的等待时间0-3秒</span>
<span class="keyword">var</span> randomTime = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
  <span class="keyword">return</span> <span class="built_in">Math</span>.random() * <span class="number">3000</span>;
};

<span class="comment">//只考虑最简单的情况promise被resolve，暂时不考虑promise被reject的情况</span>
<span class="function"><span class="keyword">function</span> <span class="title">req1</span>(<span class="params"></span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>{
    <span class="comment">//使用setTimeout()来模拟发送请求，data为请求得到的数据</span>
    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
      <span class="keyword">var</span> data = {
        <span class="string">"items"</span>: [{
          <span class="string">"name"</span>: <span class="string">"小白妹妹"</span>,
          <span class="string">"age"</span>: <span class="number">10</span>
        }, {
          <span class="string">"name"</span>: <span class="string">"小白"</span>,
          <span class="string">"age"</span>: <span class="number">100</span>
        }, {
          <span class="string">"name"</span>: <span class="string">"妹妹"</span>,
          <span class="string">"age"</span>: <span class="number">111</span>
        }],
        <span class="string">"nextPage"</span>: <span class="string">"asdfa"</span>,
        <span class="string">"lastPage"</span>: <span class="literal">null</span>
      };
      resolve(data);
      <span class="built_in">console</span>.log(<span class="string">"请求1完成"</span>);
    }, randomTime());
  })
}

<span class="function"><span class="keyword">function</span> <span class="title">req2</span>(<span class="params">dataFromReq1</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
      <span class="keyword">var</span> data = {
        <span class="string">"items"</span>: [{
          <span class="string">"name"</span>: <span class="string">"小黑姐姐"</span>,
          <span class="string">"age"</span>: <span class="number">20</span>
        }, {
          <span class="string">"name"</span>: <span class="string">"小黑"</span>,
          <span class="string">"age"</span>: <span class="number">233</span>
        }, {
          <span class="string">"name"</span>: <span class="string">"姐姐"</span>,
          <span class="string">"age"</span>: <span class="number">250</span>
        }],
        <span class="string">"nextPage"</span>: <span class="string">"gwdfx"</span>,
        <span class="string">"lastPage"</span>: <span class="string">"asdfa"</span>
      };
      <span class="built_in">console</span>.log(dataFromReq1);
      <span class="keyword">var</span> finalUserData = dataFromReq1.items.concat(data.items); <span class="comment">//将两次得到的用户数据合并</span>
      resolve(finalUserData);
      <span class="built_in">console</span>.log(<span class="string">"请求2完成"</span>);
    }, randomTime());
  })
}

<span class="comment">//让数据在promise链上欢快的传递吧～</span>
req1().then(req2).then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>{
  <span class="built_in">console</span>.log(data);
});
</code></pre><ul>
<li><p>Q: 什么时候需要返回一个promise呢？<br>A: 当你的需求逻辑是，XXX的执行需要依赖OOO的结果，此时OOO就应该返回一个promise</p>
</li>
<li><p>Q: 为什么req1要打括号，而req2不打括号？<br>A:这个我也没太搞清楚XD，我的理解是，<code>req1()</code>打括号执行后才会返回promise，不打括号就只是一个没有执行的函数，<code>req2</code>不打括号是因为then的入参只能是一个<strong>函数</strong>，如果打了括号执行后就不是函数了。</p>
</li>
<li><p>Q: 最后一个then的function(data) data是哪里来的？<br>A: <code>req2</code>的定义中，有一句<code>resolve(finalUserData)</code>，在Promise Chain中，每个then的入参的入参也就是function(data)中的data都是由前一个promise resolve时传递而来的</p>
</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜尋">
    <input type="hidden" name="q" value="site:sabrinaluo.github.io/tech">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">標籤</h3>
  <ul class="entry">
  
    <li><a href="/tech/tags/promise/">promise</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Sabrina
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/tech/js/jquery.imagesloaded.min.js"></script>
<script src="/tech/js/gallery.js"></script>




<link rel="stylesheet" href="/tech/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/tech/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>