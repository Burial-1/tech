<!DOCTYPE>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    我所理解的Promise | 小白妹妹写代码
  </title>
  <meta name="description" content="我这么可爱一定是男孩子">
  
  <meta name="keywords" content="
  promise
  ">
  
  <meta name="author" content="Sabrina">

  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp">

  <link rel="shortcut icon" type="image/ico"
        href="/tech/favicon.ico">
  <link rel="stylesheet" href="/tech/css/main.css">
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <script src="//cdn.jsdelivr.net/vue/latest/vue.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
</head>

<body>
<nav>
  <div class="container">
    <a href="/tech/" class="site-logo"><i class="fa fa-github"></i></a>
    <div class="site-search">
      <form onsubmit="return search()">
        <label class="form-control">
          <span class="scope-badge">This website</span>
          <input id="query" type="text" placeholder="Search" value="">
          <span class="scope-badge clear-search"> x </span>
        </label>
      </form>
    </div>
    <ul>
      
      <li><a href="/tech/archives">Archives</a></li>
      
      
      <li><a href="/tech/categories">Categories</a></li>
      
      
      <li><a href="/tech/tags">Tags</a></li>
      
      
      <li><a href="/tech/atom.xml">RSS</a></li>
      
    </ul>
  </div>
</nav>

<main class="container">
  <header>
  <h2>
    <i class="fa fa-book text-muted"></i>
    <a href="/tech/">小白妹妹写代码</a>
    
    
  </h2>
  <div class="header-btn">
    <div class="btn-group">
      <a href="/tech/archives" class="btn btn-group-left"><i
                class="fa fa-file-text"></i> Posts </a>
      <a href="/tech/archives"
         class="btn btn-group-right"> 28 </a>
    </div>

    <div class="btn-group">
      <a href="/tech/tags" class="btn btn-group-left"><i
                class="fa fa-tags"></i> Tags </a>
      <a href="/tech/tags"
         class="btn btn-group-right"> 91 </a>
    </div>

    <div class="btn-group">
      <a href="/tech/categories" class="btn btn-group-left"><i
                class="fa fa-list-ul"></i> Categories </a>
      <a href="/tech/categories"
         class="btn btn-group-right"> 1 </a>
    </div>
  </div>
</header>


<div class="boxed-group" xmlns="http://www.w3.org/1999/html">
  <h3>
    <i class="fa fa-user"></i>
     <a>Sabrina</a>
    <span>
      <i class="fa fa-pencil"></i> Published: 2015-12-01 18:46:26
    </span>
  </h3>
  <article>
    <h1>我所理解的Promise</h1>
    <p>（嫌我话多的可以直接看分割线之后的部分…）<br>以前高中的时候自己捣腾博客，一直也就只会用JQuery写点按钮事件什么的，连表单提交都没写过，后来误打误撞做了前端码农旧觉得JS的异步模式实在是太坑爹，当你搞清楚异步回调的时候，又会发现<a href="http://callbackhell.com/" target="_blank" rel="external">回调地狱(Callback Hell)</a>太坑爹…<br>为什么觉得异步坑爹？看看下面这个例子：</p>
<pre><code class="javascript"><span class="comment">//以下用setTimeout()模拟一个请求</span>
<span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>{
  <span class="keyword">return</span> <span class="string">"小白妹妹"</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">greeting</span>(<span class="params">name</span>) </span>{
  <span class="built_in">console</span>.log(<span class="string">"你好，"</span> + name);
}

<span class="comment">//生成一个0到1000的随机数，模拟不确定的等待时间0-1秒</span>
<span class="keyword">var</span> randomTime = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
  <span class="keyword">return</span> <span class="built_in">Math</span>.random() * <span class="number">1000</span>;
};

<span class="keyword">var</span> name = <span class="string">""</span>;
<span class="comment">//1秒之内给name赋值为 小白妹妹，但不知道具体时间</span>
setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
  name = getName();
}, randomTime());

greeting(name); <span class="comment">//以为得到name之后就可以开心的去打招呼啦，然而…</span>
</code></pre>
<h3 id="这是错的！这是错的！这是错的！"><a href="#这是错的！这是错的！这是错的！" class="headerlink" title="这是错的！这是错的！这是错的！"></a>这是错的！这是错的！这是错的！</h3><p>可能很多新手都犯过这个错误，错的时候还不知道为啥错了…深究原因的话跟JS的机制有关，长篇大论的就不在这里多说了（其实是我说不清楚…）</p>
<p>再有点经验，就会知道，应该把 <code>greeting(name)</code> 写在回调函数里，这样就能保证在得到数据之后才运行 <code>greeting()</code> 函数，于是…当你有多个请求并且之间是有这种依赖关系的时候，可怕的回调地狱就出现了！<br>而解决回调地狱其中一个很优雅的方法，就是使用传说中的promise！</p>
<p>关于promise这个概念我前前后后看了有一年了，周围也没有认识的人可以给我讲，只能自己看看网上的文章，然而…<del>并没有什么卵用</del>…网上的文章都是众说纷纭，有一上来就defer的<a href="https://github.com/alsotang/node-lessons/tree/master/lesson17" target="_blank" rel="external">^1</a>，也有一上来就说如果你还在用defer你就理解错了Promise的<a href="http://web.jobbole.com/82601/" target="_blank" rel="external">^2</a>，就所以我到现在也不知道究竟什么样的理解才是对的…</p>
<p>关于<a href="http://segmentfault.com/a/1190000002452115" target="_blank" rel="external">Promise以及A+规范</a>就不在此详述了，那些概念的东东，我也还没完全理解。我想做的是让跟我一样的小白都能明白Promise最基本的用法。</p>
<hr>
<p>举个栗子…<br>有一个第三方提供的API，访问API能够得到一些用户数据（每访问一次得到一页，假设由于某些限制一页只返回3个用户）以及下一页的index；除了第一页之外，其他的页面都需要下一页的index参数才能访问到。（先不管这个API设计的合不合理…Facebook就有这样的API）<br><a href="http://example.com/user" target="_blank" rel="external">http://example.com/user</a>  <em>–&gt;访问第一页的用户数据</em><br><a href="http://example.com/user?next=xzmca" target="_blank" rel="external">http://example.com/user?next=xzmca</a>  <em>–&gt;访问第二页的用户数据</em><br>请求第一页时返回结果如下：</p>
<pre><code class="json">{
&quot;items&quot; : [{
  &quot;name&quot; : &quot;小白妹妹&quot;,
   &quot;age&quot; : 10
  }, 
  {...},
  {...}],
&quot;nextPage&quot; : &quot;xzmca&quot;,
&quot;lastPage&quot; : null
}
</code></pre>
<p>你可能会有这样的需求：你的APP一次需要显示6个甚至更多个的用户数据。而根据之前的API，一次只能拿到3个数据，那么就只能发出两次请求，并且<strong>第二次请求依赖于第一次请求的结果</strong>，由于异步的原因我们并不知道第一个请求什么时候才完成，<del>而我最初入坑时是让程序发完第一个请求后强制等2秒再发第二个请求我会告诉你们吗…</del></p>
<p>下面为了方便，使用<code>setTimeout()</code>函数和<a href="http://bluebirdjs.com/" target="_blank" rel="external">bluebird</a>库进行说明:</p>
<pre><code class="javascript"><span class="comment">//生成一个0到3000的随机数，模拟不确定的等待时间0-3秒</span>
<span class="keyword">var</span> randomTime = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
  <span class="keyword">return</span> <span class="built_in">Math</span>.random() * <span class="number">3000</span>;
};

<span class="comment">//只考虑最简单的情况promise被resolve，暂时不考虑promise被reject的情况</span>
<span class="function"><span class="keyword">function</span> <span class="title">req1</span>(<span class="params"></span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>{
    <span class="comment">//使用setTimeout()来模拟发送请求，data为请求得到的数据</span>
    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
      <span class="keyword">var</span> data = {
        <span class="string">"items"</span>: [{
          <span class="string">"name"</span>: <span class="string">"小白妹妹"</span>,
          <span class="string">"age"</span>: <span class="number">10</span>
        }, {
          <span class="string">"name"</span>: <span class="string">"小白"</span>,
          <span class="string">"age"</span>: <span class="number">100</span>
        }, {
          <span class="string">"name"</span>: <span class="string">"妹妹"</span>,
          <span class="string">"age"</span>: <span class="number">111</span>
        }],
        <span class="string">"nextPage"</span>: <span class="string">"asdfa"</span>,
        <span class="string">"lastPage"</span>: <span class="literal">null</span>
      };
      resolve(data);
      <span class="built_in">console</span>.log(<span class="string">"请求1完成"</span>);
    }, randomTime());
  })
}

<span class="function"><span class="keyword">function</span> <span class="title">req2</span>(<span class="params">dataFromReq1</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
      <span class="keyword">var</span> data = {
        <span class="string">"items"</span>: [{
          <span class="string">"name"</span>: <span class="string">"小黑姐姐"</span>,
          <span class="string">"age"</span>: <span class="number">20</span>
        }, {
          <span class="string">"name"</span>: <span class="string">"小黑"</span>,
          <span class="string">"age"</span>: <span class="number">233</span>
        }, {
          <span class="string">"name"</span>: <span class="string">"姐姐"</span>,
          <span class="string">"age"</span>: <span class="number">250</span>
        }],
        <span class="string">"nextPage"</span>: <span class="string">"gwdfx"</span>,
        <span class="string">"lastPage"</span>: <span class="string">"asdfa"</span>
      };
      <span class="built_in">console</span>.log(dataFromReq1);
      <span class="keyword">var</span> finalUserData = dataFromReq1.items.concat(data.items); <span class="comment">//将两次得到的用户数据合并</span>
      resolve(finalUserData);
      <span class="built_in">console</span>.log(<span class="string">"请求2完成"</span>);
    }, randomTime());
  })
}

<span class="comment">//让数据在promise链上欢快的传递吧～</span>
req1().then(req2).then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>{
  <span class="built_in">console</span>.log(data);
});
</code></pre>
<ul>
<li><p>Q: 什么时候需要返回一个promise呢？<br>A: 当你的需求逻辑是，XXX的执行需要依赖OOO的结果，此时OOO就应该返回一个promise</p>
</li>
<li><p>Q: 为什么req1要打括号，而req2不打括号？<br>A:这个我也没太搞清楚XD，我的理解是，<code>req1()</code>打括号执行后才会返回promise，不打括号就只是一个没有执行的函数，<code>req2</code>不打括号是因为then的入参只能是一个<strong>函数</strong>，如果打了括号执行后就不是函数了。</p>
</li>
<li><p>Q: 最后一个then的function(data) data是哪里来的？<br>A: <code>req2</code>的定义中，有一句<code>resolve(finalUserData)</code>，在Promise Chain中，每个then的入参的入参也就是function(data)中的data都是由前一个promise resolve时传递而来的</p>
</li>
</ul>

  </article>
</div>


<div class="duoshuo">
  <!-- 多说评论框 start -->
  <div class="ds-thread" data-thread-key="1448966786" data-title="我所理解的Promise"
       data-url="http://sabrinaluo.com/tech/2015/12/01/promise/"></div>
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <script type="text/javascript">
    var duoshuoQuery = {short_name: "sabrinaluo"};
    (function () {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';
      ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
  <!-- 多说公共JS代码 end -->
</div>



</main>

<footer class="container clearfix">
  <ul class="social-link">
    <li>© 2016 Sabrina</li>

    <li><a href="http://sabrinaluo.com/tech">Home</a></li>
    
    <li><a href="https://github.com/sabrinaluo">Github</a></li>
    
    <li><a href="http://weibo.com/206663121">Weibo</a></li>
    
  </ul>
  <div class="theme-info">
    Theme <a
            href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
    by <a
            href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
  </div>
  <a href="http://sabrinaluo.com/tech" class="site-logo"><i class="fa fa-github"></i></a>
</footer>


<script>
  (function() {
    var cx = '015579750388200492852:dnpv83myu4a';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-52574938-4', 'auto');
  ga('send', 'pageview');
</script>



<script>
  var _hmt = _hmt || [];
  (function(){var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?d8749b933af749e1e5ec931bb403628f";
    var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();
</script>


<script src="/tech/js/main.js"></script>

</body>
</html>
