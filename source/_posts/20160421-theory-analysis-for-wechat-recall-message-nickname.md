---
title: 微信撤回信息昵称显示原理分析
date: 2016-04-21 17:07:08
tags: [微信，撤回信息，原理分析，双向文稿，]
---
### 吐槽
为了让各位亲朋好友方便的用撤回信息装x，本宝宝写了一个[昵称生成器](http://sabrinaluo.com/nickname-gen)
虽然是比较简单的页面，但本宝宝还没发布呢，微信就封了这个功能，宝宝心里委屈但宝宝不说…

### 起因
今天早些时候，在微信群里看到了这样的撤回信息：
```
"牛奶"撤回了一条信息并亲了你一下
```
开始的时候我是一脸懵逼的，然后知道复制牛奶的昵称，然后再修改就可以实现这个效果，**一定要复制，一个字一个字打就不行**。
之后有同学转发了[一篇文章](https://mp.weixin.qq.com/s?__biz=MzAwNDY5NzI4MQ==&mid=505551279&idx=1&sn=f10a4b837a10ed9c4a252c606f2f7c7f&scene=1&srcid=0421JP3AeSA1CmbSqEn1rLMh&from=singlemessage&isappinstalled=0&pass_ticket=HbJ8e6BomIu6b3R%2Bi6i69%2FT2TY3g%2FHUMQSItE5M2cd8%3D)，然后大家纷纷搞出了各种有趣的效果：
```
1. "zz并亲了你一下"撤回了一条消息
2. "朱饼饼息消条一了回撤"并又瘦了一斤
3. "仝哈哈"撤回了一条消息下一你了亲并
```

### 分析
机智的我一开始就猜到，肯定是有些什么看不见的特殊字符导致的。

作为一只前端狗，首先想到的当然是打开web微信，F12，看看昵称里到底是什么鬼，果然不出所料，我的昵称是这样的：`&#8238;&#8238;&#8238; 用卵么什有没并而然&#8237;萝卜`

于是开始找这个`&#8238;`特殊字符到底是做什么的，机智的我很快就找到了[^1]
首先这种字符叫做*Unicode_control_characters*[^2]
要知道更详细的内容（比如这种字符最开始是用于阿拉伯文等东亚文字的排版，另外类似的字符还有好几个，但）可以看看wiki的双向文稿[^3]，还有其他更详细的使用范例[^4]

| html特殊符号 | js unicode | 含义 |
|:------:|:---------:|:-----------|
| `&#8237;` | `\u202D` | Unicode Character 'LEFT-TO-RIGHT OVERRIDE' |
| `&#8238;` | `\u202E` | Unicode Character 'RIGHT-TO-LEFT OVERRIDE' |
所以`8237`的作用是从左到右显示，`8238`的作用是从右到左显示。

也就是说，跟在`8238`后面的字符串将从右到左显示（原来的排版方式会被override，直到遇到其他的控制排版的字符(Unicode_control_characters)）；而跟在`8237`后面的字符串将从左到右显示。

由于大家在复制的时候根本看不到这些字符，而且可能因为在修改昵称时**删除**或**加多**了这些特殊符号，所以产生了各种奇怪的效果。而前面提到的最正确我的昵称应该是只有一个`8238`，也就是这样
```
&#8238;用卵么什有没并而然&#8237;萝卜
```

微信撤回信息的显示逻辑是，`"昵称"+撤回了一条信息`，昵称前后是有引号的。
所以实际上，撤回信息的**字符串**是`"&#8238;用卵么什有没并而然&#8237;萝卜"撤回了一条信息`。
根据之前提到的`8238`和`8237`的作用以及前提条件（正常情况下我们看到的字都是从左到右显示），分解过程如下：（LTR从左到右，RTL从右到左）
1. `第一个引号是正常显示，这个引号是LTR显示的强字符： （"）
2. `&#8238;`后面的 *用卵么什有没并而然* 是RTL显示的强字符：（"然而并没有什么卵用）
3. `&#8237;`后面的 *萝卜"撤回了一条信息* 是LTR显示的强字符，所以会**紧跟**前面的LTR的强字符，也就是紧跟第一个引号 ：（"萝卜"撤回了一条信息然而并没有什么卵用）

### 其他
上面提到的有趣的效果分析：
1. 根本没有复制到特殊符号
2. 复制到特殊符号，但"并亲了你一下"被写反了，实际的文本为`&#8238;并亲了你一下&#8237;仝哈哈`
3. 复制到的特殊符号不正确，实际的文本为`&#8238;斤一了瘦又并&#8237;朱饼饼&#8238;`

[^1]: http://www.fileformat.info/info/unicode/char/202e/index.htm
[^2]: https://en.wikipedia.org/wiki/Unicode_control_characters
[^3]: https://zh.wikipedia.org/wiki/%E9%9B%99%E5%90%91%E6%96%87%E7%A8%BF
[^4]: https://www.w3.org/International/questions/qa-bidi-unicode-controls
